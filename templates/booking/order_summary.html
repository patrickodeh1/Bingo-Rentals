{% extends 'base.html' %}

{% block content %}
<div class="max-w-2xl mx-auto">
    <!-- Progress Steps -->
    <div class="mb-12">
        <div class="flex items-center justify-between">
            <div class="flex flex-col items-center">
                <div class="w-10 h-10 bg-red-600 rounded-full flex items-center justify-center text-white font-bold">âœ“</div>
                <p class="text-sm text-gray-600 mt-2">Select Product</p>
            </div>
            <div class="flex-1 h-1 bg-red-600 mx-2"></div>
            <div class="flex flex-col items-center">
                <div class="w-10 h-10 bg-red-600 rounded-full flex items-center justify-center text-white font-bold">âœ“</div>
                <p class="text-sm text-gray-600 mt-2">Choose Dates</p>
            </div>
            <div class="flex-1 h-1 bg-red-600 mx-2"></div>
            <div class="flex flex-col items-center">
                <div class="w-10 h-10 bg-red-600 rounded-full flex items-center justify-center text-white font-bold">âœ“</div>
                <p class="text-sm text-gray-600 mt-2">Your Info</p>
            </div>
            <div class="flex-1 h-1 bg-red-600 mx-2"></div>
            <div class="flex flex-col items-center">
                <div class="w-10 h-10 bg-red-600 rounded-full flex items-center justify-center text-white font-bold">4</div>
                <p class="text-sm text-gray-600 mt-2">Confirm</p>
            </div>
        </div>
    </div>
    
    <div class="bg-white rounded-lg shadow-md p-8">
        <h2 class="text-2xl font-bold mb-6">Order Summary & Secure Payment</h2>
        
        <!-- Order Details -->
        <div class="mb-8">
            <h3 class="text-lg font-bold mb-4">Booking Details</h3>
            <div class="bg-gray-50 p-4 rounded-lg space-y-2">
                <div class="flex justify-between">
                    <span class="text-gray-700">Product:</span>
                    <span class="font-semibold">{{ product.name }}</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-700">Drop-off Date:</span>
                    <span class="font-semibold">{{ booking_data.drop_off_date }}</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-700">Rental Duration:</span>
                    <span class="font-semibold">{{ booking_data.rental_months }} month(s)</span>
                </div>
                {% if booking_data.pickup_date %}
                <div class="flex justify-between border-t border-gray-200 pt-2">
                    <span class="text-gray-700">Scheduled Pickup Date:</span>
                    <span class="font-semibold text-green-600">{{ booking_data.pickup_date }}</span>
                </div>
                {% endif %}
                <div class="flex justify-between">
                    <span class="text-gray-700">Delivery Address:</span>
                    <span class="font-semibold">{{ booking_data.delivery_city }}, {{ booking_data.delivery_state }}</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-700">Contact:</span>
                    <span class="font-semibold">{{ booking_data.customer_email }}</span>
                </div>
            </div>
        </div>
        
        <!-- Price Breakdown -->
        <div class="mb-8">
            <h3 class="text-lg font-bold mb-4">Price Breakdown</h3>
            <div class="bg-red-50 p-4 rounded-lg border border-red-200">
                <div class="flex justify-between mb-3 pb-3 border-b border-red-200">
                    <span class="text-gray-700">Monthly Rental ({{ booking_data.rental_months }} month<span>{% if booking_data.rental_months != 1 %}s{% endif %}</span>):</span>
                    <span class="font-semibold">${{ monthly_cost|floatformat:2 }}</span>
                </div>
                
                <div class="flex justify-between mb-3 pb-3 border-b border-red-200">
                    <span class="text-gray-700">Transport Fee (Delivery & Removal):</span>
                    <span class="font-semibold">${{ transport_fee|floatformat:2 }}</span>
                </div>
                
                <div class="mt-4">
                    <div class="flex justify-between text-lg">
                        <span class="font-bold">Total Due Today:</span>
                        <span class="font-bold text-red-600">${{ total|floatformat:2 }}</span>
                    </div>
                </div>

                <div class="mt-4 p-3 bg-white rounded border border-red-200 text-sm">
                    <p class="text-gray-700 mb-1">
                        <strong>âœ“ This charge covers:</strong>
                    </p>
                    <ul class="text-gray-600 ml-4 mt-2 space-y-1">
                        <li>â€¢ First month's rental</li>
                        <li>â€¢ Delivery to your location</li>
                        <li>â€¢ Future pickup & removal</li>
                    </ul>
                    <p class="text-gray-600 mt-2">
                        <strong>Important:</strong> Schedule pickup at the end of the rental month. Additional charges may apply for late pickup beyond the rental period.
                    </p>
                </div>
            </div>
        </div>
        
        <!-- Payment Form -->
        <form id="payment-form" method="post" action="{% url 'booking:process_payment' %}">
            {% csrf_token %}
            <h3 class="text-lg font-bold mb-4">Payment Details</h3>
            
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-2">Card Information</label>
                <div id="card-element" class="w-full px-4 py-2 border border-gray-300 rounded-lg"></div>
                <div id="card-errors" class="text-red-500 text-sm mt-2"></div>
            </div>
            
            <div class="flex gap-4">
                <a href="{% url 'booking:customer_details' %}" 
                   class="flex-1 bg-gray-500 text-white py-3 rounded-lg font-semibold hover:bg-gray-600 transition text-center">
                    Back
                </a>
                <button type="submit" id="submit-btn"
                        class="flex-1 bg-red-600 text-white py-3 rounded-lg font-semibold hover:bg-red-700 transition disabled:opacity-50">
                    Pay ${{ total|floatformat:2 }}
                </button>
            </div>
            
            <p class="text-xs text-gray-600 mt-4 text-center">
                ðŸ”’ Secure payment powered by Stripe. Your payment information is encrypted and safe.
            </p>
            
            <input type="hidden" id="payment_intent_id" name="payment_intent_id">
        </form>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// Initialize Stripe
const stripe = Stripe('{{ stripe_public_key }}');
const elements = stripe.elements();
const cardElement = elements.create('card');
cardElement.mount('#card-element');

const clientSecret = '{{ client_secret }}';
const intentId = '{{ intent_id }}';

// Handle card errors
cardElement.addEventListener('change', function(event) {
    const displayError = document.getElementById('card-errors');
    if (event.error) {
        displayError.textContent = event.error.message;
    } else {
        displayError.textContent = '';
    }
});

// Toast notification function
function showToast(message, type = 'success') {
    const toast = document.createElement('div');
    const bgColor = type === 'success' ? 'bg-green-500' : 'bg-red-500';
    const icon = type === 'success' ? 'âœ“' : 'âœ•';
    
    toast.innerHTML = `
        <div class="${bgColor} text-white px-6 py-4 rounded-lg shadow-lg flex items-center gap-3 animate-fade-in">
            <span class="text-xl font-bold">${icon}</span>
            <span class="font-medium">${message}</span>
        </div>
    `;
    toast.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 9999; max-width: 400px;';
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.transition = 'opacity 0.3s ease';
        setTimeout(() => toast.remove(), 300);
    }, 4000);
}

// Handle form submission
document.getElementById('payment-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const submitBtn = document.getElementById('submit-btn');
    submitBtn.disabled = true;
    submitBtn.textContent = 'Processing...';
    
    try {
        // Confirm payment with Stripe
        const result = await stripe.confirmCardPayment(clientSecret, {
            payment_method: {
                card: cardElement
            }
        });
        
        if (result.error) {
            // Show error to customer
            showToast(result.error.message, 'error');
            submitBtn.disabled = false;
            submitBtn.textContent = 'Pay ${{ total|floatformat:2 }}';
        } else {
            // Payment succeeded, submit form via AJAX
            document.getElementById('payment_intent_id').value = result.paymentIntent.id;
            
            const formData = new FormData(this);
            try {
                const response = await fetch('{% url "booking:process_payment" %}', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showToast('Payment successful! Redirecting...', 'success');
                    setTimeout(() => {
                        window.location.href = data.redirect_url;
                    }, 1500);
                } else {
                    showToast(data.error || 'Payment processing failed', 'error');
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Pay ${{ total|floatformat:2 }}';
                }
            } catch (error) {
                showToast('An error occurred. Please try again.', 'error');
                submitBtn.disabled = false;
                submitBtn.textContent = 'Pay ${{ total|floatformat:2 }}';
            }
        }
    } catch (error) {
        showToast('An error occurred. Please try again.', 'error');
        submitBtn.disabled = false;
        submitBtn.textContent = 'Pay ${{ total|floatformat:2 }}';
    }
});

// Add CSS animations
const style = document.createElement('style');
style.textContent = `
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    .animate-fade-in { animation: fadeIn 0.3s ease; }
`;
document.head.appendChild(style);
</script>
{% endblock %}
