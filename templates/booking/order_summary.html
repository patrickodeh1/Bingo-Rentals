{% extends 'base.html' %}

{% block content %}
<div class="max-w-2xl mx-auto">
    <!-- Progress Steps -->
    <div class="mb-12">
        <div class="flex items-center justify-between">
            <div class="flex flex-col items-center">
                <div class="w-10 h-10 bg-blue-600 rounded-full flex items-center justify-center text-white font-bold">âœ“</div>
                <p class="text-sm text-gray-600 mt-2">Select Product</p>
            </div>
            <div class="flex-1 h-1 bg-blue-600 mx-2"></div>
            <div class="flex flex-col items-center">
                <div class="w-10 h-10 bg-blue-600 rounded-full flex items-center justify-center text-white font-bold">âœ“</div>
                <p class="text-sm text-gray-600 mt-2">Choose Dates</p>
            </div>
            <div class="flex-1 h-1 bg-blue-600 mx-2"></div>
            <div class="flex flex-col items-center">
                <div class="w-10 h-10 bg-blue-600 rounded-full flex items-center justify-center text-white font-bold">âœ“</div>
                <p class="text-sm text-gray-600 mt-2">Your Info</p>
            </div>
            <div class="flex-1 h-1 bg-blue-600 mx-2"></div>
            <div class="flex flex-col items-center">
                <div class="w-10 h-10 bg-blue-600 rounded-full flex items-center justify-center text-white font-bold">4</div>
                <p class="text-sm text-gray-600 mt-2">Confirm</p>
            </div>
        </div>
    </div>
    
    <div class="bg-white rounded-lg shadow-md p-8">
        <h2 class="text-2xl font-bold mb-6">Order Summary & Secure Payment</h2>
        
        <!-- Order Details -->
        <div class="mb-8">
            <h3 class="text-lg font-bold mb-4">Booking Details</h3>
            <div class="bg-gray-50 p-4 rounded-lg space-y-2">
                <div class="flex justify-between">
                    <span class="text-gray-700">Product:</span>
                    <span class="font-semibold">{{ product.name }}</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-700">Drop-off Date:</span>
                    <span class="font-semibold">{{ booking_data.drop_off_date }}</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-700">Rental Duration:</span>
                    <span class="font-semibold">{{ booking_data.rental_months }} month(s)</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-700">Delivery Address:</span>
                    <span class="font-semibold">{{ booking_data.delivery_city }}, {{ booking_data.delivery_state }}</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-700">Contact:</span>
                    <span class="font-semibold">{{ booking_data.customer_email }}</span>
                </div>
            </div>
        </div>
        
        <!-- Price Breakdown -->
        <div class="mb-8">
            <h3 class="text-lg font-bold mb-4">Price Breakdown</h3>
            <div class="bg-blue-50 p-4 rounded-lg">
                <div class="flex justify-between mb-2">
                    <span>Monthly Rental ({{ booking_data.rental_months }} month<span>{% if booking_data.rental_months != 1 %}s{% endif %}</span>):</span>
                    <span class="font-semibold">${{ monthly_cost|floatformat:2 }}</span>
                </div>
                <div class="flex justify-between mb-2">
                    <span>Delivery / Drop-off Fee:</span>
                    <span class="font-semibold">${{ delivery_fee|floatformat:2 }}</span>
                </div>
                <div class="border-t border-blue-200 pt-2 mt-2">
                    <div class="flex justify-between text-lg">
                        <span class="font-bold">Total Charge:</span>
                        <span class="font-bold text-blue-600">${{ total|floatformat:2 }}</span>
                    </div>
                </div>
                <p class="text-xs text-gray-600 mt-3">This charge covers the first month rental plus delivery fee. Pickup fees will be charged separately when you schedule pickup.</p>
            </div>
        </div>
        
        <!-- Payment Form -->
        <form id="payment-form" method="post" action="{% url 'booking:process_payment' %}">
            {% csrf_token %}
            <h3 class="text-lg font-bold mb-4">Payment Details</h3>
            
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-2">Card Information</label>
                <div id="card-element" class="w-full px-4 py-2 border border-gray-300 rounded-lg"></div>
                <div id="card-errors" class="text-red-500 text-sm mt-2"></div>
            </div>
            
            <div class="flex gap-4">
                <a href="{% url 'booking:customer_details' %}" 
                   class="flex-1 bg-gray-500 text-white py-3 rounded-lg font-semibold hover:bg-gray-600 transition text-center">
                    Back
                </a>
                <button type="submit" id="submit-btn"
                        class="flex-1 bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition disabled:opacity-50">
                    Pay ${{ total|floatformat:2 }}
                </button>
            </div>
            
            <p class="text-xs text-gray-600 mt-4 text-center">
                ðŸ”’ Secure payment powered by Stripe. Your payment information is encrypted and safe.
            </p>
            
            <input type="hidden" id="payment_intent_id" name="payment_intent_id">
        </form>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// Initialize Stripe
const stripe = Stripe('{{ stripe_public_key }}');
const elements = stripe.elements();
const cardElement = elements.create('card');
cardElement.mount('#card-element');

const clientSecret = '{{ client_secret }}';
const intentId = '{{ intent_id }}';

// Handle card errors
cardElement.addEventListener('change', function(event) {
    const displayError = document.getElementById('card-errors');
    if (event.error) {
        displayError.textContent = event.error.message;
    } else {
        displayError.textContent = '';
    }
});

// Handle form submission
document.getElementById('payment-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const submitBtn = document.getElementById('submit-btn');
    submitBtn.disabled = true;
    submitBtn.textContent = 'Processing...';
    
    try {
        // Confirm payment with Stripe
        const result = await stripe.confirmCardPayment(clientSecret, {
            payment_method: {
                card: cardElement
            }
        });
        
        if (result.error) {
            // Show error to customer
            document.getElementById('card-errors').textContent = result.error.message;
            submitBtn.disabled = false;
            submitBtn.textContent = 'Pay ${{ total|floatformat:2 }}';
        } else {
            // Payment succeeded, submit form
            document.getElementById('payment_intent_id').value = result.paymentIntent.id;
            this.submit();
        }
    } catch (error) {
        document.getElementById('card-errors').textContent = 'An error occurred. Please try again.';
        submitBtn.disabled = false;
        submitBtn.textContent = 'Pay ${{ total|floatformat:2 }}';
    }
});
</script>
{% endblock %}
